# HTTPRoutes for Backend TLS testing
#
# These routes forward traffic to the NGINX TLS backend
# Each route uses a different service to test different TLS policies:
#   - /api/backend-tls/standard/ → nginx-tls (Standard BackendTLSPolicy)
#   - /api/backend-tls/simple/   → nginx-tls-simple (KGateway simpleTLS: true)
#   - /api/backend-tls/mtls/     → nginx-tls-mtls (KGateway mTLS)
#
# NGINX annotations covered:
#   1. nginx.ingress.kubernetes.io/configuration-snippet: |
#        proxy_ssl_name "nginx-tls.ingress2kgateway.svc.cluster.local";
#      → BackendTLSPolicy.validation.hostname / BackendConfigPolicy.tls.sni
#
#   2. nginx.ingress.kubernetes.io/proxy-ssl-secret: ingress2kgateway/nginx-tls-client-cert
#      → BackendConfigPolicy.tls.secretRef (for mTLS)
#
# Note: backend-protocol annotation (HTTPS/HTTP/gRPC) is a separate feature
# covering multiple protocols and will be validated separately.

---
# =============================================================================
# Test 17a: Route for Standard BackendTLSPolicy (Simple TLS)
# =============================================================================
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: backend-tls-standard-route
  namespace: ingress2kgateway
  labels:
    app: nginx-tls
    test: backend-tls-17a
spec:
  parentRefs:
  - name: external-gateway
    namespace: ingress2kgateway
    sectionName: https
  hostnames:
  - "i2g.${DOMAIN}"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: "/api/backend-tls/standard/"
    backendRefs:
    - name: nginx-tls
      port: 8443

---
# =============================================================================
# Test 17b: Route for KGateway BackendConfigPolicy (Simple TLS)
# =============================================================================
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: backend-tls-simple-route
  namespace: ingress2kgateway
  labels:
    app: nginx-tls
    test: backend-tls-17b
spec:
  parentRefs:
  - name: external-gateway
    namespace: ingress2kgateway
    sectionName: https
  hostnames:
  - "i2g.${DOMAIN}"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: "/api/backend-tls/simple/"
    backendRefs:
    - name: nginx-tls-simple
      port: 8443

---
# =============================================================================
# Test 17c: Route for KGateway BackendConfigPolicy (mTLS)
# =============================================================================
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: backend-tls-mtls-route
  namespace: ingress2kgateway
  labels:
    app: nginx-tls
    test: backend-tls-17c
spec:
  parentRefs:
  - name: external-gateway
    namespace: ingress2kgateway
    sectionName: https
  hostnames:
  - "i2g.${DOMAIN}"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: "/api/backend-tls/mtls/"
    backendRefs:
    - name: nginx-tls-mtls
      port: 8443
