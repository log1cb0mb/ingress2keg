# Standard Gateway API Timeout Test
# ═══════════════════════════════════════════════════════════════════════════
#
# Purpose: Demonstrate PORTABLE timeout configuration using standard Gateway API
#          (works with any Gateway API implementation, not just Envoy Gateway)
#
# Comparison:
#   - THIS FILE: Standard Gateway API (HTTPRoute.timeouts)
#   - 04-backend-traffic-policy.yaml: Envoy Gateway-specific (BackendTrafficPolicy.timeout)
#
# NGINX Equivalent:
#   nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
#   nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
#
# Reference: https://gateway-api.sigs.k8s.io/geps/gep-1742/
#
# ═══════════════════════════════════════════════════════════════════════════

---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: standard-timeout-route
  namespace: ingress2envoygateway
  labels:
    app: standard-timeout-test
    test-type: gateway-api-standard
    portability: upstream-compatible
spec:
  parentRefs:
  - name: external-gateway
    namespace: ingress2envoygateway
    sectionName: https
  
  hostnames:
  - "eg.${DOMAIN}"
  
  rules:
  # ═══════════════════════════════════════════════════════════════════════
  # Test Route: Standard Gateway API Timeouts
  # ═══════════════════════════════════════════════════════════════════════
  #
  # Timeouts:
  #   - request: 60s (total time for request/response cycle)
  #   - backendRequest: 30s (time for backend to respond)
  #
  # ═══════════════════════════════════════════════════════════════════════
  - matches:
    - path:
        type: PathPrefix
        value: "/api/standard/timeout/"
    
    # Standard Gateway API Timeouts (GEP-1742)
    timeouts:
      request: 60s          # Total time for entire request/response cycle
      backendRequest: 30s   # Time for backend to start responding
    
    backendRefs:
    - name: echo-server
      port: 8080

# ═══════════════════════════════════════════════════════════════════════════
# COMPARISON: Two Ways to Configure Timeouts
# ═══════════════════════════════════════════════════════════════════════════
#
# ┌─────────────────────────────────────────────────────────────────────────┐
# │ METHOD 1: Standard Gateway API (THIS FILE)                              │
# │ ────────────────────────────────────────────────────────────────────────│
# │ API: gateway.networking.k8s.io/v1 HTTPRoute                             │
# │ Portability: ✅ Works with ANY Gateway API implementation               │
# │                                                                         │
# │ Fields:                                                                 │
# │   - timeouts.request: Total request/response time                       │
# │   - timeouts.backendRequest: Time for backend to respond                │
# │                                                                         │
# │ Reference: https://gateway-api.sigs.k8s.io/geps/gep-1742/               │
# └─────────────────────────────────────────────────────────────────────────┘
#
# ┌─────────────────────────────────────────────────────────────────────────┐
# │ METHOD 2: Envoy Gateway BackendTrafficPolicy                            │
# │ ────────────────────────────────────────────────────────────────────────│
# │ API: gateway.envoyproxy.io/v1alpha1 BackendTrafficPolicy                │
# │ Portability: ❌ Envoy Gateway-specific (vendor lock-in)                 │
# │                                                                         │
# │ Fields:                                                                 │
# │   - timeout.http.requestTimeout: Same as standard                       │
# │   - timeout.http.connectionIdleTimeout: Idle timeout (NOT in standard)  │
# │   - timeout.tcp.connectTimeout: TCP connect timeout                     │
# │                                                                         │
# │ Use when: Need TCP connect timeout or idle timeout                      │
# └─────────────────────────────────────────────────────────────────────────┘
#
# ═══════════════════════════════════════════════════════════════════════════
# NGINX → Gateway API Timeout Mapping
# ═══════════════════════════════════════════════════════════════════════════
#
# | NGINX Annotation      | Standard Gateway API    | Envoy Gateway BTP         |
# |-----------------------|-------------------------|---------------------------|
# | proxy-read-timeout    | timeouts.request        | timeout.http.requestTimeout|
# | proxy-send-timeout    | timeouts.backendRequest | timeout.http.connectionIdleTimeout |
# | proxy-connect-timeout | N/A                     | timeout.tcp.connectTimeout |
#
# ═══════════════════════════════════════════════════════════════════════════
